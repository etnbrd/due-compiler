<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>due compiler</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="repo.css" media="screen"/>
</head>

<body>


  <div class="container">
    
    <div class='step'>
      <input type="file" id="input">
    </div>

  </div>

  <div class='control'>
    <button class="next">next</button>
  </div>


  <script src="scripts/compiler.bundle.js" type="text/javascript" charset="utf-8"></script>
  <script src="scripts/estools.bundle.js" type="text/javascript" charset="utf-8"></script>
  <script src="scripts/jquery.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="scripts/jszip.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="scripts/jszip-utils.min.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript">
    
    // var fileInput = document.getElementById("input");
    // var next = document.getElementById("next");
    var fileInput = $('#input');
    var nextButton = $('.next');
    var container = $('.container');

    var URL = 'labels/';


    function getIdString(id) {
      if (id && id.type === 'Identifier') {
        return id.name;
      }

      if (id && id.type === 'MemberExpression' && !id.computed) {

        var object = getIdString(id.object);
        var property = getIdString(id.property);
        if (object && property)
          return  object + '.' + property; 
      }

      return id
    }


    function usedModules(file) {
      var ast = esprima.parse(file);

      // Build the parenting backlink needed for the next steps in the compilation.
      estraverse.traverse(ast, {
        enter: function(n, p) {
          n.parent = p;
        }
      })

      var res = esquery.query(ast, 'CallExpression > [name="require"]' );

      var modules = res.reduce(function(modules, elm) {
        if (elm.parent.arguments[0].type === 'Literal') {
          modules.push(elm.parent.arguments[0].value)
        }
        return modules;
      }, []);

      return modules;
    }

    function doNext(fn) {
      nextButton.off('click');
      nextButton.on('click', fn);
    }

    function ProcessZipBall(data) {

      var zip = new JSZip(data);

      var files = Object.keys(zip.files).reduce(function(files, filename) {
        if (filename.split('.').pop() === 'js') {
          var file = zip.files[filename];
          files[filename] = file;
        }
        return files;
      }, {});

      // STEP 1 : ASK WHICH JS FILES TO CONVERT
      // displayFiles(files);

      function next() {
        // STEP 1.2 : trim unchecked Files
        processModules(getCheckedFiles(files));
      }

      doNext(next);
    }

    function processModules(files) {

      // console.log(files)

      var modules = Object.keys(files).reduce(function(modules, filename) { var file = files[filename];

        return usedModules(file.data).reduce(function(modules, module) {
          modules[module] = modules[module] || [];
          modules[module].push(file.name);
          return modules;
        }, modules);
      }, {})

      // STEP 2 : ASK FOR MODULES COMPATIBILITY
      displayModules(modules);





      function next() {
        // STEP 2.2 : compile stuff
        var processed = Object.keys(files).length;
        console.log('>>> NX ', processed);

        function callback() {

          console.log('>>> CB ', this.name);

          var _callback = Array.prototype.pop.call(arguments);

          function _next() {

            console.log('>>> _NX', this.name);

            // Call all the _callback only when the user consent
            // _callback.apply(this, arguments);

            console.log(processed);

            if (--processed === 0) {
              processed = files.length
              displayLabels(files);
            }
          }

          Array.prototype.push.call(arguments, _next.bind(this));

          ProcessLabels.apply(this, arguments);
        }

        function end() {
          // ProcessResult.apply(this, arguments);

          if (--processed === 0) {
            // displayResults(files);
          }
        }

        for(var filename in files) { var file = files[filename];
          compiler(file.data, callback.bind(file), end.bind(file));
          // compiler(file.data, ProcessLabels.bind(file), ProcessResult.bind(file));        
        }

      }

      doNext(next);
    }


    function ProcessLabels(err, potentialRP, callback) {
      if (err) throw err
      // TODO display errors

      // STEP 3 : ASK FOR THE LABELS

      this.labels = potentialRP.reduce(function(labels, rp) {
        var id = getIdString(rp.parent.callee);

        if (id) {
          labels[id] = labels[id] || [];
          labels[id].push(rp);
        }

        return labels;
      }, {})

      this.callback = callback;

      $.ajax({
        type: "GET",
        url: URL + Object.keys(this.labels).join(','),
        // crossDomain: true,
        success: ProcessMarkers.bind(this),
        dataType: 'JSON'
      });

      this.callback = callback;

    }


    function ProcessMarkers(statusRP) {

      var self = this;

      this.markers = Object.keys(this.labels).reduce(function(markers, label) {
        if (statusRP[label]) {
          var sync = statusRP[label].sync;
          var async = statusRP[label].async;
        } else {
          var sync = 0;
          var async = 0;
        }

        function toMarker(rp, label) {
          return {
            label : label,
            rp : rp,
            loc : rp.parent.callee.loc,
            isRupturePoint : (async > sync),
            crowdGuess : (async > sync),
            count : sync + async,
            accuracy : Math.max(async, sync) / (async + sync)
          }
        }

        self.labels[label].forEach(function(rp) {
          markers.push(rp.marker = toMarker(rp, label));
        })
        return markers;
      }, [])

      // console.log('MARKERS >> ', markers);
      // updateMarkers(markers);



      // var rps = markers.reduce(function(rps, marker) {
      //   if (marker.isRupturePoint)
      //     rps.push(marker.rp.parent);

      //   return rps;
      // }, [])



      try {
        this.callback(null, this.markers);
      } catch (e) {
        displayError(e);
      }
    }


    function ProcessResult() {
      // console.log(arguments);
    }


    function UploadMarkers() {
      var labels = _markers.reduce(function(labels, marker) {

        if (!labels[marker.label]
        ||  labels[marker.label].isRupturePoint === marker.isRupturePoint) {
          labels[marker.label] = {isRupturePoint: marker.isRupturePoint};
        } else {
          delete labels[marker.label];
        }

        return labels;
      }, {});

      $.post(URL, JSON.stringify(labels))
      .fail(function(e) { console.log("error", e.statusCode()); });

    }

    //////////////////////////////////////
    // FRONT END
    //////////////////////////////////////


    function displayFiles(files) {
      // console.log(files);

      container.append(
        Object.keys(files).reduce(function(list, filename) { var file = files[filename];

          var checkbox = $('<input type=\'checkbox\' id=\'' + filename + '\' checked>');
          var spanFilename = $('<label for=\'' + filename + '\'><span class=\'filename\'>' + filename + '</span><label>');
          var spanFile = $('<pre class=\'code\'>' + file.data + '</pre>');
          var li = $('<li class=\'file\'></li>').append(checkbox).append(spanFilename).append(spanFile);

          list.find('ul').append(li);

          return list;
        }, $('<div class=\'step\'><h1>Select the files to compile</h1><ul class=\'files\'></ul></div>'))
      );
    }

    function getCheckedFiles(files) {
      $('.files > li > input:not(:checked) + .filename').each(function(index, filename) {
        var name = $(filename).text();
        delete files[name];
      })

      return files;
    }


    function displayModules(modules) {
      // console.log(modules);

      container.append(
        Object.keys(modules).reduce(function(list, module) {

          var spanModule = $('<span class=\'module\'>' + module + '</span>');
          var spanFiles = $('<span class=\'files\'>' + modules[module].join(', ') + '</span>');
          var li = $('<li></li>').append(spanModule).append(spanFiles);

          list.find('ul').append(li);

          return list;
        }, $('<div class=\'step\'><h1>Do you already use promise-like modules ?</h1><ul class=\'modules\'></ul></div>'))
      )

    }

    function displayLabels(files) {
      console.log(files);
      console.log('>>> DISPLAY LABELS');

      container.append(
        Object.keys(files).reduce(function(list, filename) { var file = files[filename];

          // console.log(file);

          var checkbox = $('<input type=\'checkbox\' id=\'' + filename + '\' checked>');
          var spanFilename = $('<label for=\'' + filename + '\'><span class=\'filename\'>' + filename + '</span><label>');
          var ulMarkers = file.markers.reduce(function(markers, marker) {

            var id = marker.loc.start.line + ':' + marker.loc.start.column

            var checkbox = $('<input type=\'checkbox\' id=\'' + id + '\' checked>');
            var spanMarker = $('<label for=\'' + id + '\'><span class=\'filename\'>' + marker.label + '</span> </span class=\'position\'>' + marker.loc.start.line + ':' + marker.loc.start.column + '</span><label>');
            var li = $('<li class=\'marker\'></li>').append(checkbox).append(spanMarker);

            return markers.append(li);

            return markers
          }, $('<ul class=\'markers\'></ul>'));

          var li = $('<li class=\'file\'></li>').append(spanFilename).append(ulMarkers);

          list.find('ul.files').append(li);

          return list;
        }, $('<div class=\'step\'><h1>Select the asynchronous continuations</h1><ul class=\'files\'></ul></div>'))
      );

    }


    function displayError(err) {
      console.error(err);

      // var error = $('<div class="error"><div class="close">✖</div><span class="message"></span></div>');

      // $(error).find('.message').text(err);
      // $(error).find('.close').click(function() {
      //   error.remove();
      // })

      // errors.append(error);
    }


    //////////////////////////////////////
    // GET THE ZIPBALL
    //////////////////////////////////////

    JSZipUtils.getBinaryContent('master.zip', function(err, data) {
      if(err) throw err; // or handle err
      ProcessZipBall(data)
    });

  </script>

</body>
</html>